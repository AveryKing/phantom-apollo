name: Deploy Full Stack
on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1 
  REPO_NAME: phantom-apollo

jobs:
  deploy-backend:
    name: Deploy Backend & API
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    outputs:
      api_url: ${{ steps.deploy-api.outputs.url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Configure Docker'
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # 1. Deploy phantom-apollo (The original Express/Discord/Cron backend)
      - name: 'Build & Push Backend'
        run: |
          docker build -t "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/phantom-apollo:${{ github.sha }}" -f Dockerfile .
          docker push "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/phantom-apollo:${{ github.sha }}"

      - name: 'Deploy Backend'
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: 'phantom-apollo'
          region: '${{ env.REGION }}'
          image: '${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/phantom-apollo:${{ github.sha }}'
          flags: '--allow-unauthenticated'
          env_vars: |
             NODE_ENV=production
             SUPABASE_URL=${{ secrets.SUPABASE_URL }}
             SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
             GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }}
             DISCORD_PUBLIC_KEY=${{ secrets.DISCORD_PUBLIC_KEY }}
             GOOGLE_SEARCH_API_KEY=${{ secrets.GOOGLE_SEARCH_API_KEY }}
             GOOGLE_CX=${{ secrets.GOOGLE_CX }}
             SERVICE_URL=${{ secrets.SERVICE_URL }}
             LANGFUSE_PUBLIC_KEY=${{ secrets.LANGFUSE_PUBLIC_KEY }}
             LANGFUSE_SECRET_KEY=${{ secrets.LANGFUSE_SECRET_KEY }}
             LANGFUSE_HOST=${{ secrets.LANGFUSE_HOST }}

      # 2. Deploy phantom-apollo-api (The LangGraph Server)
      - name: 'Build & Push LangGraph API'
        run: |
          docker build -t "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/phantom-apollo-api:${{ github.sha }}" -f Dockerfile.api .
          docker push "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/phantom-apollo-api:${{ github.sha }}"

      - name: 'Deploy LangGraph API'
        id: deploy-api
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: 'phantom-apollo-api'
          region: '${{ env.REGION }}'
          image: '${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/phantom-apollo-api:${{ github.sha }}'
          flags: '--allow-unauthenticated'
          env_vars: |
             NODE_ENV=production
             SUPABASE_URL=${{ secrets.SUPABASE_URL }}
             SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
             GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }}
             GOOGLE_LOCATION=${{ env.REGION }}

  deploy-ui:
    name: Deploy Frontend
    needs: deploy-backend
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Configure Docker'
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # 3. Deploy phantom-apollo-ui (The Next.js Frontend)
      - name: 'Build & Push UI'
        env:
          NEXT_PUBLIC_API_URL: ${{ needs.deploy-backend.outputs.api_url }}
        run: |
          # Build args are used to bake the API URL into the Next.js static files
          docker build \
            --build-arg NEXT_PUBLIC_API_URL=${{ needs.deploy-backend.outputs.api_url }} \
            -t "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/phantom-apollo-ui:${{ github.sha }}" \
            -f agent-chat-ui/Dockerfile .
          docker push "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/phantom-apollo-ui:${{ github.sha }}"

      - name: 'Deploy UI'
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: 'phantom-apollo-ui'
          region: '${{ env.REGION }}'
          image: '${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/phantom-apollo-ui:${{ github.sha }}'
          flags: '--allow-unauthenticated'
          env_vars: |
             NEXT_PUBLIC_API_URL=${{ needs.deploy-backend.outputs.api_url }}
             NEXT_PUBLIC_ASSISTANT_ID=agent
